Lesson3 それっぽいプログラム - ロバのみみblog -
===================================

Lesson3に入る前に
-----------------------------------

これ以降、composerというPHPの便利ツールを使います。

[公式サイトを参考に](https://getcomposer.org/)インストールしておいてください。

みなさんの実行しているプログラム(なんとか.php)が置いてあるディレクトリに「lib」というディレクトリを
作ってそこにインストールしておくことをおすすめします。

それっぽいプログラムを書いてみよう
-----------------------------------

ではさっそく**それっぽい**プログラムを書いてみたいと思います。
記事を送信したら表示してくれる。っていう便利プログラムです。

その名も「ロバのみみblog」。

っていうわけで、何を作らないといけないか、考えてみましょう

1. 入力する画面(HTML)
2. 出力結果(HTML)
3. どうやって出力結果を生成するのか(PHP)

今のところ、入力画面には暫定で[input.html](input.html)のようなHTMLを作ってみました。
誰が書いたのか、どんな記事なのか。

そして、出力結果は多分[output.html](output.html)のようなHTMLであればそれっぽい感じです。

というわけでPHPでどうやってoutput.htmlのようなHTMLを作るのでしょうか…?

やらないといけないことは多分

1. input.htmlで入力された内容を「送信ボタン」が押されたらPHPがどうにかして理解する
2. PHPでprintを駆使してHTMLを作る

といった内容になると思います。

送信ボタンが押されたらPHPがデータを受け取る
--------------------------------

### どのPHPのプログラムに送信するのか

[input.html](input.html)の中に

```html
<form action='blog.php' method='POST'>
  <label for='name'>お名前</label>
  <input type='text' id='name'>
  <label for='article'>記事本文</label>
  <textarea id='article'></textarea>
  <input type='submit'>
</form>
```

と書かれた部分があります。この中の`<form action='blog.php'`と書かれた部分が
「送信ボタン」を押した時に入力された情報を受けとるプログラムになります。

あとは`<input type='text' id='name'>`のidのところがPHPで受けとる時に「何のデータ」かを
判別する時に判断材料になるものです。今回の例だと「name」という名前のデータとPHPは判断してくれます。
あと`<textarea id='article'></textarea>`の部分で「article」という名前のデータをPHPは受けとることができます。

### PHPでデータを受けとる

PHPでデータを受け取るには

```
$_POST['名前']
```

という変数にデータが入っているので、それを使用します。

nameという名前のデータは`$_POST['name']`に、articleという名前のデータは`$_POST['article']`に
入っています。

ということは、そのまま

```php
print($_POST['name']);
```

というプログラムを書けばそのまま表示されます。…ということは…

```PHP
<?php
print('<!DOCTYPE html>');
print('<html>');
print('  <head>');
print('    <meta name="charset" content="UTF-8">');
print('    <title>ロバのみみblog 表示画面</title>');
print('  </head>');
print('  <body>');
print('    <h1>ロバのみみblog 表示画面</h1>');
print('    <h2>投稿者</h2>');
print('    <p>' . $_POST['name'] .'</p>');
print('    <h2>本文</h2>');
print('    <p>');
print($_POST['article']);
print('    </p>');
print('  </body>');
print('</html>');
```

と書けばOK!です!まずはやってみましょう!

できた!すごい!!!!

めんどくせー!
-----------------------------

なんだこれ、HTML修正しようと思ったらPHP変更しないといけないんかい!!!

ちょっとHTMLの構造(divとか)イジろうものならprint書きなおし…ってそんな使いづらいわ!!!!1

### そんな時のテンプレートエンジン

そんな時に使用するのが**テンプレートエンジン**。これを使うと超便利。

#### テンプレートエンジンって?

[Lesson1](../Lesson1/)あたりでプログラムの基本は「入力 → 処理 → 出力」と進んでいくと説明しました。
入力と処理はしかたないのですが、「出力」の際になんでもプログラムに書いてしまうと、
変更とかが大変だったり、デザイナーさんとプログラマーの作業分担が大変だったりします。

そこで、「どんな風に表示したい!」というものを「テンプレート」という形で別に作っておき、
プログラマーはそのテンプレートにデータをはめ込むだけ!というようなものができる仕組みがあると
プログラマーもデザイナーも楽になります。

こんな風にテンプレートを使えるようにしくみを「テンプレートエンジン」と言います。

さっきのprintてんこもりのPHPファイルを表示の処理とテンプレートに分離してみます。

[Twig](http://twig.sensiolabs.org/)というテンプレートエンジンを使用してやります。
ダウンロードして、展開し、libディレクトリの中に「twig」というディレクトリ名に置いておいてください。

テンプレートは[こちら](templates/output.tpl)、プログラムは[こちら](twig.php)。
そして入力のinput.htmlはtwig.phpにデータを送信するように

```html
<form action="blog.php" method="POST">
```
を
```html
<form action="twig.php" method="POST">
```
に書き換えます。

実行結果は同じですが、プログラムを書く人の立場、
デザイナー(コーディングする人)の立場で見た場合、どっちが楽でしょうか?

そうだよね。テンプレートエンジン使ったほうが楽だよね(強制);

というわけで、今後はテンプレートエンジンを使ってプログラムを書いていきましょう。

そして、気付いたら「ロバのみみblog」は完成してました。やったね!

### 安全なHTMLを出力する

教科書の104ページには「悪意のある入力を防ぐhtmlspecialchars関数」や120ページには「改行を正しく処理してテキストエリアの内容を表示しましょう」といったものが紹介されていますが、プログラム側でそれを忘れてしまうことが多々あります。

また、どの項目をそのまま使用したいのかをデザイナーが制御できたほうが都合が良いこともあります。

そういった時にTwigのフィルターを使用します。

```php
{{article}}
```

となっているところは改行のところで自動的に<br>が挿入されないのですが、

```php
{{article|nl2br}}
```
と書き換えると入るようになります。
この機能をフィルターといい、nl2br以外にもいろいろなフィルターがあります。

公式サイトに[いろいろなフィルター](http://twig.sensiolabs.org/doc/filters/index.html)が
紹介されていますので試してみてください。


またテンプレートの最初に

```
{% autoescape %}
```
テンプレートの最後に
```
{% endautoescape %}
```
~~を記載するとTwigを使用して表示する内容を自動的にエスケープしてくれます。~~ と思ったらTwigではデフォルトでautoescapeらしいです。
明示的に内容を表示したい時は[rawフィルター](http://twig.sensiolabs.org/doc/filters/raw.html)を使用しましょう。

見た目の制御をプログラマーにまかせず、デザイナーが制御できる。というのがここでは大切になります。

### 課題2 ロバのみみblogをデコってみよう

今のままでは超殺風景なロバのみみblog…みんなのセンスでデコってみよう!
(bootstrapとかそういうの使ってみるといいかも!)

もし **テンプレートエンジンを使わないで** 同じようにデコったら…どうなる?
